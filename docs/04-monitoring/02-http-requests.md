# HTTP Request Monitoring

The SDK monitors HTTP requests and responses through the `NadiMiddleware`, capturing duration,
status codes, headers, payloads, and controller actions.

## How It Works

`NadiMiddleware` is added to the CakePHP middleware queue during plugin bootstrap. For each request:

1. The start time is recorded before the request is handled
2. The response is generated by the application
3. `HandleHttpRequestEvent` checks if the status code should be tracked
4. If the status code is not in the ignored list, an entry is created
5. The entry includes request/response details, duration, and memory usage

## Ignored Status Codes

By default, success and redirect status codes are ignored:

| Range | Codes |
|-------|-------|
| Informational | 100, 101, 102, 103 |
| Success | 200, 201, 202, 203, 204, 205, 206, 207 |
| Redirection | 300, 302, 303, 304, 305, 306, 307, 308 |

Only 4xx and 5xx responses are captured. Customize the ignored list in `config/nadi.php`:

```php
'http' => [
    'ignored_status_codes' => [200, 201, 204, 301, 302],
],
```

## Captured Data

| Field | Description |
|-------|-------------|
| `title` | Summary (e.g., `/api/users returned HTTP Status Code 500`) |
| `description` | Full description with method and status |
| `uri` | Request URI |
| `method` | HTTP method (GET, POST, etc.) |
| `controller_action` | CakePHP controller and action (e.g., `Users@index`) |
| `headers` | Request headers (sensitive headers masked) |
| `payload` | Request body (sensitive parameters masked) |
| `response_status` | HTTP status code |
| `response` | Response body (JSON, plain text, or "HTML Response") |
| `duration` | Request duration in milliseconds |
| `memory` | Peak memory usage in KB |

## Security

Sensitive data is automatically masked before storage.

### Hidden Headers

Request headers matching these names are replaced with `********`:

- `authorization`
- `php-auth-pw`

Configure additional hidden headers:

```php
'http' => [
    'hidden_request_headers' => [
        'authorization',
        'php-auth-pw',
        'x-custom-secret',
    ],
],
```

### Hidden Parameters

Request body parameters matching these names are replaced with `********`:

- `password`
- `password_confirmation`

Configure additional hidden parameters:

```php
'http' => [
    'hidden_parameters' => [
        'password',
        'password_confirmation',
        'credit_card',
    ],
],
```

## Response Handling

Response bodies are processed based on content:

| Condition | Stored Value |
|-----------|-------------|
| Body exceeds 64KB | `"Purged By Nadi"` |
| Valid JSON | Re-encoded JSON string |
| Content-Type is `text/plain` | Raw body text |
| All other content types | `"HTML Response"` |

## Tags

Each HTTP entry is tagged with:

- HTTP method (e.g., `GET`)
- Status code (e.g., `500`)
- `http.method:{method}`
- `http.status_code:{code}`
- `cakephp.controller:{name}` (if available)
- `cakephp.action:{name}` (if available)

## Next Steps

- [Slow Query Monitoring](03-slow-queries.md) - Database query tracking
- [Configuration](../03-configuration/03-environment-variables.md) - HTTP configuration options
